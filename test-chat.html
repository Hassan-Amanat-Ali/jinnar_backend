<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Chat Debugger</title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --chat-bg: #ffffff; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; height: 100vh; display: flex; background: var(--bg); }
        
        /* Sidebar */
        aside { width: 280px; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .user-header { padding: 20px; background: #1e293b; color: white; }
        .user-header small { display: block; opacity: 0.7; font-size: 0.8rem; margin-top: 5px; word-break: break-all; }
        
        .online-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-row { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .user-row:hover { background: #f8fafc; }
        .user-row.active { background: #eff6ff; border: 1px solid #bfdbfe; }
        .status-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 0 2px white; }
        
        /* Main Chat */
        main { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { padding: 15px 25px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; height: 60px;}
        
        #chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 70%; padding: 12px 16px; border-radius: 16px; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: white; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 8px; display: block; }
        
        .controls { padding: 20px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 25px; outline: none; transition: 0.2s; }
        input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 3px #bfdbfe; }
        
        .btn { padding: 10px 20px; border-radius: 25px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .file-upload { position: relative; overflow: hidden; display: inline-block; }
        .file-upload input[type=file] { position: absolute; font-size: 100px; right: 0; top: 0; opacity: 0; cursor: pointer; }
        .icon-btn { background: #f1f5f9; color: #64748b; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

        /* Overlay */
        #auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .auth-box { background: white; padding: 30px; border-radius: 12px; width: 400px; text-align: center; }
        .auth-box input { width: 100%; margin: 15px 0; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
        
        #preview-container { position: absolute; bottom: 80px; left: 20px; right: 20px; background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; display: none; }
        #preview-img { height: 60px; border-radius: 4px; }
        .close-preview { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; text-align: center; line-height: 20px; font-size: 12px;}
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h2>üîê Login Debugger</h2>
            <p>Enter JWT Token to connect as User</p>
            <input type="text" id="jwt-input" placeholder="Paste Bearer Token...">
            <button class="btn btn-primary" onclick="connect()">Connect Socket</button>
        </div>
    </div>

    <aside>
        <div class="user-header">
            <h3 style="margin:0">My Account</h3>
            <small id="my-id-display">Not Connected</small>
        </div>
        <div class="online-list" id="user-list">
            </div>
    </aside>

    <main>
        <header>
            <span id="chat-title">Select a user to start</span>
            <span id="typing-indicator" style="color: #64748b; font-style: italic; font-size: 0.9rem;"></span>
        </header>

        <div id="chat-area"></div>

        <div id="preview-container">
            <div class="close-preview" onclick="clearAttachment()">√ó</div>
            <img id="preview-img" src="" alt="">
            <span style="margin-left: 10px; font-size: 12px; color: #666;">Image ready to send</span>
        </div>

        <div class="controls">
            <div class="file-upload">
                <div class="icon-btn">üìé</div>
                <input type="file" id="file-input" accept="image/*" onchange="handleFileSelect(this)">
            </div>
            <input type="text" id="msg-input" placeholder="Type a message..." disabled onkeypress="handleEnter(event)">
            <button id="send-btn" class="btn btn-primary" disabled onclick="sendMessage()">Send</button>
        </div>
    </main>

    <script>
        let socket;
        let myUserId;
        let currentReceiver = null;
        let pendingAttachment = null; // { url: base64, type: 'image' }

        // Check for saved token
        window.onload = () => {
            const saved = localStorage.getItem('debug_token');
            if(saved) document.getElementById('jwt-input').value = saved;
        }

        function connect() {
            const token = document.getElementById('jwt-input').value.trim();
            if(!token) return alert("Token needed");

            // 1. Decode Token to get ID
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                myUserId = payload.id;
                document.getElementById('my-id-display').textContent = "ID: " + myUserId;
            } catch(e) { return alert("Invalid JWT"); }

            localStorage.setItem('debug_token', token);
            document.getElementById('auth-overlay').style.display = 'none';

            // 2. Initialize Socket
            socket = io('http://localhost:3000', { auth: { token } });

            // 3. Connection Events
            socket.on('connect', () => {
                console.log('Connected');
                document.getElementById('msg-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
            });

            socket.on('connect_error', (err) => {
                alert("Connection Failed: " + err.message);
                document.getElementById('auth-overlay').style.display = 'flex';
            });

            // 4. Online Users Logic
            socket.on('getOnlineUsers', (users) => {
                updateUserList(users);
            });

            socket.on('userOnlineStatus', () => {
                // In this simple version, we just ask for the full list again 
                // allows us to be lazy with set logic on frontend
                // Ideally: Modify the Set locally
                // Since we don't have an emit for "getOnlineUsers" from client, we rely on the server pushing updates
                // OR: We can manually maintain the list:
            });
            
            // Better approach for status updates:
            socket.on('userOnlineStatus', ({ userId, isOnline }) => {
               const el = document.getElementById(`user-${userId}`);
               if(isOnline && !el) {
                   // Add to list (simplified: just reload page logic or add visually)
                   // For testing, let's just log it. The server logic I gave you works.
                   // To make UI update perfectly, we need a local Set.
                   updateUserListInternal(userId, true);
               } else if (!isOnline && el) {
                   updateUserListInternal(userId, false);
               }
            });

            // 5. Message Logic
            socket.on('newMessage', (data) => {
                const otherId = data.sender._id === myUserId ? data.receiver._id : data.sender._id;
                
                // If chatting with this person, show message
                if (currentReceiver === otherId || (currentReceiver === data.sender._id)) {
                    appendMessage(data);
                }
            });

            socket.on('userTyping', ({ senderId, isTyping }) => {
                if(senderId === currentReceiver) {
                    document.getElementById('typing-indicator').innerText = isTyping ? 'typing...' : '';
                }
            });
        }

        // --- UI HELPERS ---

        const onlineSet = new Set();

        function updateUserList(usersArray) {
            usersArray.forEach(id => onlineSet.add(id));
            renderList();
        }

        function updateUserListInternal(id, isOnline) {
            if(isOnline) onlineSet.add(id);
            else onlineSet.delete(id);
            renderList();
        }

        function renderList() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            
            onlineSet.forEach(id => {
                if(id === myUserId) return;
                
                const div = document.createElement('div');
                div.id = `user-${id}`;
                div.className = `user-row ${currentReceiver === id ? 'active' : ''}`;
                div.innerHTML = `<span>User ${id.slice(-4)}</span> <div class="status-dot"></div>`;
                div.onclick = () => selectUser(id);
                list.appendChild(div);
            });
        }

        function selectUser(id) {
            currentReceiver = id;
            document.getElementById('chat-title').textContent = `Chatting with ...${id.slice(-4)}`;
            document.getElementById('chat-area').innerHTML = ''; // Clear chat (in real app fetch history)
            renderList(); // update active class
        }

        // --- FILE & MESSAGE HANDLING ---

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                pendingAttachment = {
                    url: base64,
                    type: file.type.startsWith('video') ? 'video' : 'image',
                    public_id: 'test_' + Date.now() // Mock ID for DB
                };
                
                // Show preview
                document.getElementById('preview-img').src = base64;
                document.getElementById('preview-container').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearAttachment() {
            pendingAttachment = null;
            document.getElementById('file-input').value = '';
            document.getElementById('preview-container').style.display = 'none';
        }

        function handleEnter(e) {
            if(e.key === 'Enter') sendMessage();
            
            // Typing emitter
            if(currentReceiver) {
                socket.emit('typing', { receiverId: currentReceiver, isTyping: true });
                clearTimeout(window.typingTimer);
                window.typingTimer = setTimeout(() => {
                    socket.emit('typing', { receiverId: currentReceiver, isTyping: false });
                }, 1000);
            }
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();

            if((!text && !pendingAttachment) || !currentReceiver) return;

            const payload = {
                receiverId: currentReceiver,
                message: text,
                attachment: pendingAttachment
            };

            socket.emit('sendMessage', payload, (ack) => {
                if(ack.status !== 'ok') alert('Error sending');
            });

            input.value = '';
            clearAttachment();
        }

        function appendMessage(data) {
            const isMe = data.sender._id === myUserId;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let content = data.message || '';
            if(data.attachment && data.attachment.url) {
                if(data.attachment.type === 'image') {
                    content += `<img src="${data.attachment.url}">`;
                } else {
                    content += `<div>[Video Attachment]</div>`;
                }
            }
            
            div.innerHTML = content;
            
            const area = document.getElementById('chat-area');
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }
    </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Final Integration Tester</title>
    <script src="https://jinnar-marketplace.onrender.com/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); }
        
        /* Sidebar */
        aside { width: 300px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; }
        .header { padding: 20px; background: #1f2937; color: white; }
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-row { padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .user-row:hover { background: #f9fafb; }
        .user-row.active { background: #e0e7ff; border-left: 4px solid var(--primary); }
        .dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; }
        .offline { background: #9ca3af; }

        /* Chat Area */
        main { flex: 1; display: flex; flex-direction: column; }
        .chat-head { height: 60px; border-bottom: 1px solid #e5e7eb; background: white; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 70%; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: white; color: #1f2937; border-bottom-left-radius: 2px; }
        .msg img { max-width: 200px; border-radius: 8px; margin-top: 10px; display: block; }
        .msg-meta { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; }

        /* Inputs */
        .controls { padding: 20px; background: white; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        
        /* Auth Modal */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 400px; text-align: center; }
        .modal-box input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;}

        /* Preview */
        #preview-area { position: absolute; bottom: 85px; left: 20px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #preview-img { height: 80px; border-radius: 4px; }
        .x-btn { position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; text-align: center; line-height: 20px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="modal">
        <div class="modal-box">
            <h2>üöÄ System Tester</h2>
            <p>Paste JWT Token to test DB & Notifications</p>
            <input type="text" id="token-input" placeholder="Bearer eyJhbGci...">
            <button onclick="initApp()">Connect</button>
        </div>
    </div>

    <aside>
        <div class="header">
            <h3>My Dashboard</h3>
            <small id="my-id">...</small>
        </div>
        <div class="user-list" id="user-list"></div>
    </aside>

    <main>
        <div class="chat-head">
            <strong id="chat-title">Select a user...</strong>
            <small id="typing-status" style="color: #6b7280; font-style: italic;"></small>
        </div>

        <div id="messages"></div>

        <div id="preview-area">
            <div class="x-btn" onclick="clearFile()">√ó</div>
            <img id="preview-img" src="">
            <div style="font-size: 10px; color: green; margin-top: 5px;">Image attached</div>
        </div>

        <div class="controls">
            <input type="file" id="file-input" style="display: none;" accept="image/*" onchange="showPreview(this)">
            
            <button onclick="document.getElementById('file-input').click()" style="padding: 8px 12px; background: #e5e7eb; color: #374151;">üìé</button>
            
            <input type="text" id="msg-input" placeholder="Type message..." disabled onkeypress="handleEnter(event)">
            <button id="send-btn" onclick="sendViaApi()" disabled>Send (API)</button>
        </div>
    </main>

    <script>
        // CONFIGURATION
        const API_URL = 'https://jinnar-marketplace.onrender.com'; // Your Backend URL
        
        let socket;
        let myUserId;
        let token;
        let currentReceiver = null;
        const onlineUsers = new Set();

        // 1. Load Token logic
        window.onload = () => {
            const saved = localStorage.getItem('test_token');
            if(saved) document.getElementById('token-input').value = saved;
        }

        function initApp() {
            token = document.getElementById('token-input').value.trim();
            if(!token) return alert("Token required");
            
            // Parse ID
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                myUserId = payload.id; // Ensure your JWT has 'id'
                document.getElementById('my-id').innerText = `ID: ${myUserId}`;
            } catch(e) { return alert("Invalid Token"); }

            localStorage.setItem('test_token', token);
            document.getElementById('modal').style.display = 'none';
            
            connectSocket();
        }

        // 2. Socket Connection (For Real-time Updates)
        function connectSocket() {
            socket = io(API_URL, { auth: { token } });

            socket.on('connect', () => {
                console.log("‚úÖ Socket Connected");
                document.getElementById('msg-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
            });

            // Initial Online List
            socket.on('getOnlineUsers', (ids) => {
                ids.forEach(id => onlineUsers.add(id));
                renderUsers();
            });

            // Status Updates
            socket.on('userOnlineStatus', ({ userId, isOnline }) => {
                if(isOnline) onlineUsers.add(userId);
                else onlineUsers.delete(userId);
                renderUsers();
            });

            // MESSAGE RECEIVED (This proves the API -> DB -> Socket loop worked)
            socket.on('newMessage', (msg) => {
                console.log("üì© Real-time update received:", msg);
                
                const otherId = msg.sender._id === myUserId ? msg.receiver._id : msg.sender._id;
                
                if(currentReceiver === otherId || currentReceiver === msg.sender._id) {
                    addMessageToUi(msg);
                }
            });

            // Typing
            socket.on('userTyping', ({ senderId, isTyping }) => {
                if(senderId === currentReceiver) {
                    document.getElementById('typing-status').innerText = isTyping ? 'typing...' : '';
                }
            });
        }

        // 3. SEND MESSAGE VIA REST API (Triggers DB & Notification)
        async function sendViaApi() {
            const text = document.getElementById('msg-input').value;
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if((!text && !file) || !currentReceiver) return;

            // Prepare FormData
            const formData = new FormData();
            formData.append('receiverId', currentReceiver);
            if(text) formData.append('message', text);
            if(file) formData.append('attachment', file);

            // Button loading state
            const btn = document.getElementById('send-btn');
            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/chat/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // Note: DO NOT set Content-Type here, fetch sets it automatically for FormData
                    },
                    body: formData
                });

                const result = await response.json();

                if(result.success) {
                    console.log("‚úÖ Saved to DB & Notification Triggered");
                    document.getElementById('msg-input').value = '';
                    clearFile();
                } else {
                    alert("Error: " + result.message);
                }

            } catch (err) {
                console.log(err);
                alert("API Request Failed");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                // Note: We do NOT add message to UI here. 
                // We wait for socket.on('newMessage') to do it.
            }
        }

        // --- UI Helpers ---

        function renderUsers() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            
            onlineUsers.forEach(id => {
                if(id === myUserId) return;
                
                const div = document.createElement('div');
                div.className = `user-row ${currentReceiver === id ? 'active' : ''}`;
                div.innerHTML = `
                    <span>User ${id.slice(-4)}</span> 
                    <div class="dot"></div>
                `;
                div.onclick = () => loadChat(id);
                list.appendChild(div);
            });
        }

        function loadChat(id) {
            currentReceiver = id;
            document.getElementById('chat-title').innerText = `Chat with ...${id.slice(-4)}`;
            document.getElementById('messages').innerHTML = ''; // In real app, fetch history here
            renderUsers();
        }

        function addMessageToUi(msg) {
            const isMe = msg.sender._id === myUserId;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let content = `<div>${msg.message || ''}</div>`;
            
            if(msg.attachment && msg.attachment.url) {
                content += `<img src="${msg.attachment.url}" alt="Attachment">`;
            }
            
            div.innerHTML = content + `<div class="msg-meta">${new Date(msg.createdAt).toLocaleTimeString()}</div>`;
            
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showPreview(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-area').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearFile() {
            document.getElementById('file-input').value = '';
            document.getElementById('preview-area').style.display = 'none';
        }

        function handleEnter(e) {
            if(e.key === 'Enter') sendViaApi();
            
            // Typing emitter (still goes via socket)
            if(currentReceiver) {
                socket.emit('typing', { receiverId: currentReceiver, isTyping: true });
                clearTimeout(window.tTimer);
                window.tTimer = setTimeout(() => {
                    socket.emit('typing', { receiverId: currentReceiver, isTyping: false });
                }, 1000);
            }
        }

    </script>
</body>
</html>